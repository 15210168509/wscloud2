/*! grunt 2018-11-16 */

var baseUrl=$("#baseUrl").val();$(function(){function e(){if(null!=document.getElementById("nowDiv")){var e=new Date,t="";t=(t=(t=(t=(t=e.getFullYear()+"年")+(e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1)+"月")+(e.getDate()<10?"0"+e.getDate():e.getDate())+"日 ")+(e.getHours()<10?"0"+e.getHours():e.getHours())+":")+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+":",t+=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds(),document.getElementById("nowDiv").innerHTML=t}}function t(){$.ajax({type:"post",url:p+"/Stat/statTiredNo",dataType:"json",success:function(e){1==e.code&&e.data.y.length>0?d.setOption({title:{subtext:""},xAxis:[{data:e.data.x}],series:[{data:e.data.y}]}):d.setOption({title:{subtext:"暂无数据"}})}})}function a(){$.ajax({type:"post",url:p+"/Stat/showTiredType",dataType:"json",data:{timeType:"today"},success:function(e){g.hideLoading(),1==e.code?g.setOption({series:[{data:e.data}]}):g.setOption({series:[{data:[{name:"暂无数据",value:0}]}]})}})}function o(){null!=b&&(clearInterval(b),b=null,0==h.length)||(b=setInterval(function(){s()},4e3))}function s(){$.ajax({type:"post",url:p+"/Stat/showTiredValue",data:{device:h},dataType:"json",success:function(e){1==e.code&&(v&&(f.legend={type:"scroll"}),f.series=e.data,u.setOption(f,v),v=!1)}})}function i(){null!=_&&(clearInterval(_),_=null,0==h.length)||(_=setInterval(function(){n()},4e3))}function n(){$.ajax({type:"post",url:p+"/Stat/showVehicle",data:{device:h},dataType:"json",success:function(e){1==e.code&&(e.data.driving&&(e.data.driving.north&&e.data.driving.north.forEach(function(e,t){var a=gcoord.transform([e[0],e[1]],gcoord.GCJ02,gcoord.BD09);e[0]=a[0],e[1]=a[1]}),e.data.driving.south&&e.data.driving.south.forEach(function(e,t){var a=gcoord.transform([e[0],e[1]],gcoord.GCJ02,gcoord.BD09);e[0]=a[0],e[1]=a[1]}),e.data.driving.east&&e.data.driving.east.forEach(function(e,t){var a=gcoord.transform([e[0],e[1]],gcoord.GCJ02,gcoord.BD09);e[0]=a[0],e[1]=a[1]}),e.data.driving.west&&e.data.driving.west.forEach(function(e,t){var a=gcoord.transform([e[0],e[1]],gcoord.GCJ02,gcoord.BD09);e[0]=a[0],e[1]=a[1]})),e.data.stop&&(e.data.stop.north&&e.data.stop.north.forEach(function(e,t){var a=gcoord.transform([e[0],e[1]],gcoord.GCJ02,gcoord.BD09);e[0]=a[0],e[1]=a[1]}),e.data.stop.south&&e.data.stop.south.forEach(function(e,t){var a=gcoord.transform([e[0],e[1]],gcoord.GCJ02,gcoord.BD09);e[0]=a[0],e[1]=a[1]}),e.data.stop.east&&e.data.stop.east.forEach(function(e,t){var a=gcoord.transform([e[0],e[1]],gcoord.GCJ02,gcoord.BD09);e[0]=a[0],e[1]=a[1]}),e.data.stop.west&&e.data.stop.west.forEach(function(e,t){var a=gcoord.transform([e[0],e[1]],gcoord.GCJ02,gcoord.BD09);e[0]=a[0],e[1]=a[1]})),T.setOption({series:[{type:"scatter",coordinateSystem:"bmap",data:e.data.driving.north,symbol:"image:///Public/Images/office/gps_icon/green_north_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.driving.south,symbol:"image:///Public/Images/office/gps_icon/green_south_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.driving.east,symbol:"image:///Public/Images/office/gps_icon/green_east_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.driving.west,symbol:"image:///Public/Images/office/gps_icon/green_west_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.stop.north,symbol:"image:///Public/Images/office/gps_icon/blue_north_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.stop.east,symbol:"image:///Public/Images/office/gps_icon/blue_east_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.stop.south,symbol:"image:///Public/Images/office/gps_icon/blue_south_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.stop.west,symbol:"image:///Public/Images/office/gps_icon/blue_west_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.offLine.north,symbol:"image:///Public/Images/office/gps_icon/white_north_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.offLine.south,symbol:"image:///Public/Images/office/gps_icon/white_west_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.offLine.east,symbol:"image:///Public/Images/office/gps_icon/white_east_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}},{type:"scatter",coordinateSystem:"bmap",data:e.data.offLine.west,symbol:"image:///Public/Images/office/gps_icon/white_south_24.png",symbolSize:[28,28],label:{emphasis:{show:!0,formatter:function(e){return e.data[2]},position:"top"}}}]}))}})}function r(e){I.subscribe(S)}function l(e){var t=$(".t_num1 i"),a=String(e).length;t.length<e.length&&($(".t_num1").prepend("<i></i>"),P="1,"+P);for(n=0;n<a;n++){var o=String(e).charAt(n),s=58*-parseInt(o),i=$(".t_num1 i").eq(n);"1"==P.split(",")[n]?0!=o?i.animate({backgroundPosition:"(0 "+String(s)+"px)"},"slow","swing",function(){}):i.css("background-position","0px 0px"):i.animate({backgroundPosition:"(0 -580px)"},"slow","swing",function(){i.css("background-position","0px 0px")})}for(var n=0;n<a;n++){o=String(e).charAt(n);0==n&&(P=""),n<a-1?9!=o||9!=String(e).charAt(n+1)&&""!=String(e).charAt(n+1)?P+="1,":P+="0,":9!=o||9!=String(e).charAt(n+1)&&""!=String(e).charAt(n+1)?P+="1":P+="0"}k+=1,B=e.length>String(k).length?B.substring(0,e.length-String(k).length)+""+k:k+""}var c=document.documentElement.clientHeight-170-.02*document.documentElement.clientHeight;$("#title").height(c);setInterval(function(){e()},1e3);var p=$("#baseUrl").val(),d=echarts.init(document.getElementById("tired_no"),"westeros"),m={title:{},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},xAxis:[{type:"category",data:[],axisTick:{alignWithLabel:!0},splitLine:{show:!1}}],yAxis:[{type:"value",minInterval:1}],series:[{name:"报警次数",type:"bar",data:[],itemStyle:{normal:{color:function(e){return["#9b8bba","#e098c7","#8fd3e8","#71669e","#cc70af","#7cb4cc"][e.dataIndex]}},emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};d.setOption(m),t();var g=echarts.init(document.getElementById("tired_type"),"westeros"),y={title:{},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{show:!1},series:[{name:"疲劳类型",type:"pie",radius:["45%","60%"],data:[],itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};g.setOption(y),g.showLoading(),a();var u=echarts.init(document.getElementById("tired_value"),"westeros"),f={title:{},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}}},xAxis:{type:"category",boundaryGap:!1,data:[]},yAxis:{max:100,min:0,type:"value"},series:[]};u.setOption(f,!0);var h=[],b=null,v=!1,T=echarts.init(document.getElementById("map")),w={bmap:{center:[108.953098279,34.2777998978],zoom:5,roam:!0,mapStyle:{styleJson:[{featureType:"land",elementType:"geometry",stylers:{color:"#020213"}},{featureType:"building",elementType:"geometry",stylers:{color:"#04406F"}},{featureType:"building",elementType:"labels",stylers:{visibility:"off"}},{featureType:"highway",elementType:"geometry",stylers:{color:"#015B99"}},{featureType:"highway",elementType:"labels",stylers:{visibility:"off"}},{featureType:"arterial",elementType:"geometry",stylers:{color:"#003051"}},{featureType:"arterial",elementType:"labels",stylers:{visibility:"off"}},{featureType:"green",elementType:"geometry",stylers:{visibility:"off"}},{featureType:"water",elementType:"geometry",stylers:{color:"#044161"}},{featureType:"subway",elementType:"geometry.stroke",stylers:{color:"#003051"}},{featureType:"subway",elementType:"labels",stylers:{visibility:"off"}},{featureType:"railway",elementType:"geometry",stylers:{visibility:"off"}},{featureType:"railway",elementType:"labels",stylers:{visibility:"off"}},{featureType:"all",elementType:"labels.text.stroke",stylers:{color:"#313131"}},{featureType:"all",elementType:"labels.text.fill",stylers:{color:"#FFFFFF"}},{featureType:"manmade",elementType:"geometry",stylers:{visibility:"off"}},{featureType:"manmade",elementType:"labels",stylers:{visibility:"off"}},{featureType:"local",elementType:"geometry",stylers:{visibility:"off"}},{featureType:"local",elementType:"labels",stylers:{visibility:"off"}},{featureType:"subway",elementType:"geometry",stylers:{lightness:-65}},{featureType:"railway",elementType:"all",stylers:{lightness:-40}},{featureType:"boundary",elementType:"geometry",stylers:{color:"#8b8787",weight:"1",lightness:-29}}]}},series:[],tooltip:{padding:10,backgroundColor:"#222",borderColor:"#777",borderWidth:1,triggerOn:"click",formatter:function(e){var t=e.value;return"驾驶车辆："+t[2]+"<br>当时车速："+t[3].speed+"km/h<br>当时位置："+t[3].position+"<br>定位时间："+t[3].gps_time+"<br>"},position:function(e,t,a){var o=$(a).width(),s=$("#mapStoreClass");$(a).css("position","initial"),$(s).html(a),$(s).css("left",e[0]+20),$(s).css("top",e[1]+20),$(s).css("width",o+15)}}};T.setOption(w);var _=null;layui.use(["form","layer","tree"],function(){var e=$("#baseUrl").val(),t=(layui.form,layui.layer);layui.tree;$.ajax({type:"post",url:e+"/Stat/typeGroupsLists",data:{type:10},dataType:"json",success:function(e){1==e.code?layui.tree({elem:"#demo",nodes:e.data,click:function(e){$("#input_"+e.group_id+"_"+e.id).is(":checked")?$("#input_"+e.group_id+"_"+e.id).prop("checked",!1):$("#input_"+e.group_id+"_"+e.id).prop("checked",!0);var t=[];$(".input_device").each(function(){$(this).is(":checked")&&t.push($(this).attr("data"))}),v=!0,h=t,s(),o(),n(),i()}}):t.msg(e.msg)}})}),$("#closeVehicleMsg").click(function(){$(".vehicleMsg").css("display","none"),$("#msgBody").html("")});var S=$("#adminTopic").val(),x=$("#mqttServer").val(),C=$("#mqttServerPort").val(),I=new Messaging.Client(x,Number(C),"admin-"+Math.floor(1e5*Math.random()));I.onConnect=r,I.onMessageArrived=function(e){$("#msgContainer").hasClass("msgContainer")&&$("#msgContainer").removeClass("msgContainer"),$("#msgContainer").addClass("msgContainer");var o=JSON.parse(e.payloadString);if(20==o.msgType){l(B),t(),a();var s=o.data;console.log(s),$("#msg").prepend('<div class="layui-col-md12 tiredMsg"><div class="layui-col-md3">'+s.vehicle_no+'</div><div class="layui-col-md3">'+s.driver_name+'</div><div class="layui-col-md3">'+s.time_text+'</div><div class="layui-col-md3">'+s.code_text+"</div></div>"),s.tired_value>$("#tiredWarningNumber").val()&&($("#msgBody").html('<p><span class="msgTitle">车牌号:</span>'+s.vehicle_no+'</p><p><span class="msgTitle">疲劳值:</span>'+s.tired_value+'</p><p><span class="msgTitle">司机:</span>'+s.driver_name+'</p><p><span class="msgTitle">预警类型:</span>'+s.code_text+'</p><p><span class="msgTitle">速度:</span>'+s.speed+' km/h</p><p><span class="msgTitle">位置:</span>'+s.location+"</p>"),setTimeout(function(){$(".vehicleMsg").css("display","none"),$("#msgBody").html("")},1e4))}},I.onConnectionLost=function(e){0!==e.errorCode&&console.log(I.clientId+": "+e.errorCode+"\n")},I.connect({onSuccess:r,onFailure:function(e){console.log(e.errorMessage)}});var B=$("#sumTiredNo").val(),k=parseInt(B),P="1,1,1,1,1,1,1";l(B)});